generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum ClientStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum ServiceStatus {
  ACTIVE
  CANCELED
  UNKNOWN
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum MilestoneStatus {
  OPEN
  DONE
}

enum ServiceType {
  DOMAIN
  HOSTING
  EMAIL
  CDN
  LICENSE
  MONITORING
  PAYMENT
  CMS
  OTHER
}

enum NotificationType {
  RENEWAL
  TASK
  INACTIVITY
  HANDOVER
}

enum NotificationStatus {
  OPEN
  SNOOZED
  HANDLED
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  clients     Client[]
  projects    Project[]
  milestones  Milestone[]
  tasks       Task[]
  taskDependencies TaskDependency[]
  notes       Note[]
  notifications Notification[]
  activityLog ActivityLog[]
}

model User {
  id           String   @id @default(uuid())
  workspaceId  String
  email        String   @unique
  name         String?
  role         Role     @default(MEMBER)
  passwordHash String?
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Client {
  id          String       @id @default(uuid())
  workspaceId String
  name        String
  status      ClientStatus @default(ACTIVE)
  pinnedNotes String?
  tags        String[]     @default([])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  services      Service[]
  projects      Project[]
  tasks         Task[]
  assetLinks    AssetLink[]
  vaultPointers VaultPointer[]
}

model Project {
  id          String        @id @default(uuid())
  workspaceId String
  clientId    String
  name        String
  keyPrefix   String
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client    Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  milestones Milestone[]
  tasks     Task[]

  @@index([workspaceId, status, updatedAt])
  @@index([clientId, updatedAt])
  @@unique([workspaceId, keyPrefix])
}

model Milestone {
  id          String          @id @default(uuid())
  workspaceId String
  projectId   String
  title       String
  dueAt       DateTime?
  status      MilestoneStatus @default(OPEN)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status, dueAt])
  @@index([projectId, dueAt])
}

model Task {
  id          String     @id @default(uuid())
  workspaceId String
  clientId    String?
  projectId   String?
  title       String
  status      TaskStatus @default(TODO)
  dueAt       DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client    Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project   Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  blockedBy  TaskDependency[] @relation("TaskBlockedBy")
  blocks     TaskDependency[] @relation("TaskBlocks")

  @@index([workspaceId, status, dueAt])
  @@index([clientId, dueAt])
  @@index([projectId, dueAt])
}

model TaskDependency {
  id            String   @id @default(uuid())
  workspaceId   String
  blockedTaskId String
  blockerTaskId String
  createdAt     DateTime @default(now())

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  blockedTask Task      @relation("TaskBlockedBy", fields: [blockedTaskId], references: [id], onDelete: Cascade)
  blockerTask Task      @relation("TaskBlocks", fields: [blockerTaskId], references: [id], onDelete: Cascade)

  @@unique([blockedTaskId, blockerTaskId])
  @@index([workspaceId, createdAt])
  @@index([blockedTaskId])
  @@index([blockerTaskId])
}

model Note {
  id         String   @id @default(uuid())
  workspaceId String
  authorId   String
  entityType String
  entityId   String
  body       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt])
  @@index([workspaceId, entityType, entityId, createdAt])
}

model Service {
  id         String        @id @default(uuid())
  clientId   String
  provider   String
  type       ServiceType
  name       String
  status     ServiceStatus @default(ACTIVE)
  renewalDate DateTime?
  cycle      String?       // e.g. yearly, monthly
  costCents  Int?
  currency   String?       // EUR, GBP
  autoRenew  Boolean       @default(false)
  payer      String?       // client / us / shared
  reminderRules Json       @default("[]") // e.g. [60,30,14,7]
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model AssetLink {
  id        String   @id @default(uuid())
  clientId  String
  kind      String   // e.g. "hosting_panel", "repo", "wp_admin"
  label     String
  url       String
  environment String? // prod/stage
  tags      String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model VaultPointer {
  id          String   @id @default(uuid())
  clientId    String
  label       String
  vaultItemId String
  fieldName   String
  usernameHint String?
  ownerUserId String?
  lastVerifiedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model ActivityLog {
  id         String   @id @default(uuid())
  workspaceId String
  actorId    String
  action     String
  entityType String
  entityId   String
  metadata   Json
  createdAt  DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt])
}

model Notification {
  id          String             @id @default(uuid())
  workspaceId String
  type        NotificationType
  status      NotificationStatus @default(OPEN)
  entityType  String
  entityId    String
  title       String
  message     String
  dueAt       DateTime
  snoozedUntil DateTime?
  handledAt   DateTime?
  handledById String?
  dedupeKey   String
  metadata    Json               @default("{}")
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, status, dueAt])
  @@index([workspaceId, type, dueAt])
  @@unique([workspaceId, dedupeKey])
}
